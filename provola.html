<script>
const allData = {entries};
let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
let currentItem = null;

function toggleFavorite(id) {{
  if(favorites.includes(id)) {{
    favorites = favorites.filter(f=>f!==id);
  }} else {{
    favorites.push(id);
  }}
  localStorage.setItem("favorites", JSON.stringify(favorites));
  render(true);
}}

const grid = document.getElementById('moviesGrid');
const overlay = document.getElementById('playerOverlay');
const iframe = overlay.querySelector('iframe');
const latestDiv = document.getElementById('latest');

/* Sezione dettaglio full-page */
let detailPage = document.createElement('div');
detailPage.id = 'detailPage';
detailPage.style.display = 'none';
detailPage.style.padding = '20px';
detailPage.style.background = '#141414';
detailPage.style.color = '#fff';
detailPage.innerHTML = `
  <button id="backToGrid" style="margin-bottom:10px;padding:6px 12px;background:#e50914;border:none;color:#fff;border-radius:5px;cursor:pointer;">← Torna alla griglia</button>
  <h2 id="detailTitle"></h2>
  <img id="detailPoster" style="max-width:300px;display:block;margin:10px 0;">
  <p id="detailGenres"></p>
  <p id="detailVote"></p>
  <p id="detailOverview"></p>
  <p id="detailYear"></p>
  <p id="detailDuration"></p>
  <p id="detailCast"></p>
  <select id="detailSeason" style="display:none;margin:5px;"></select>
  <select id="detailEpisode" style="display:none;margin:5px;"></select>
  <button id="detailPlayBtn" style="padding:8px 12px;background:#e50914;border:none;color:#fff;border-radius:5px;cursor:pointer;">Riproduci</button>
  <span id="detailFavorite" class="favorite-btn" style="font-size:22px;margin-left:10px;cursor:pointer;">★</span>
`;
document.body.appendChild(detailPage);

const detailTitle = document.getElementById('detailTitle');
const detailPoster = document.getElementById('detailPoster');
const detailGenres = document.getElementById('detailGenres');
const detailVote = document.getElementById('detailVote');
const detailOverview = document.getElementById('detailOverview');
const detailYear = document.getElementById('detailYear');
const detailDuration = document.getElementById('detailDuration');
const detailCast = document.getElementById('detailCast');
const detailSeason = document.getElementById('detailSeason');
const detailEpisode = document.getElementById('detailEpisode');
const detailPlayBtn = document.getElementById('detailPlayBtn');
const detailFavorite = document.getElementById('detailFavorite');
const backToGrid = document.getElementById('backToGrid');

backToGrid.onclick = () => {{
  history.pushState({{page:"grid"}}, "", "#grid");
  detailPage.style.display = 'none';
  grid.style.display = 'grid';
}};

function openDetail(item, push=true) {{
  currentItem = item;
  grid.style.display = 'none';
  detailPage.style.display = 'block';
  
  detailTitle.textContent = item.title;
  detailPoster.src = item.poster;
  detailGenres.textContent = "Generi: " + item.genres.join(", ");
  detailVote.textContent = "★ " + item.vote;
  detailOverview.textContent = item.overview || "";
  detailYear.textContent = item.year ? "Anno: " + item.year : "";
  detailDuration.textContent = item.duration ? "Durata: " + item.duration + " min" : "";
  detailCast.textContent = item.cast && item.cast.length ? "Cast: " + item.cast.slice(0,5).join(", ") : "";

  detailFavorite.classList.toggle("active", favorites.includes(item.id));
  detailFavorite.onclick = () => {{
    toggleFavorite(item.id);
    detailFavorite.classList.toggle("active", favorites.includes(item.id));
  }};

  detailSeason.style.display = 'none';
  detailEpisode.style.display = 'none';
  if(item.type==='tv') {{
    detailSeason.style.display = 'inline';
    detailEpisode.style.display = 'inline';
    detailSeason.innerHTML = "";
    for(let s=1;s<=item.seasons;s++) {{
      let o = document.createElement('option');
      o.value = s;
      o.textContent = "Stagione " + s;
      detailSeason.appendChild(o);
    }}
    detailSeason.onchange = updateEpisodes;
    updateEpisodes();
  }}

  detailPlayBtn.onclick = () => openPlayer(item);

  function updateEpisodes() {{
    let season = parseInt(detailSeason.value);
    let epCount = item.episodes[season] || 1;
    detailEpisode.innerHTML = "";
    for(let e=1;e<=epCount;e++) {{
      let o = document.createElement('option');
      o.value = e;
      o.textContent = "Episodio " + e;
      detailEpisode.appendChild(o);
    }}
  }}

  if(push) {{
    history.pushState({{page:"detail", itemId:item.id}}, "", "#detail-"+item.id);
  }}
}}

function openPlayer(item, push=true) {{
  let link = item.link;
  if(item.type==='tv') {{
    let season = parseInt(detailSeason.value) || 1;
    let episode = parseInt(detailEpisode.value) || 1;
    link = `https://vixsrc.to/tv/${{item.id}}/${{season}}/${{episode}}?lang=it&sottotitoli=off&autoplay=1`;
  }} else {{
    link = `https://vixsrc.to/movie/${{item.id}}/?lang=it&sottotitoli=off&autoplay=1`;
  }}
  overlay.style.display='flex';
  iframe.src = link;
  if (overlay.requestFullscreen) overlay.requestFullscreen();
  else if (overlay.webkitRequestFullscreen) overlay.webkitRequestFullscreen();
  else if (overlay.msRequestFullscreen) overlay.msRequestFullscreen();

  if(push) {{
    history.pushState({{page:"player", itemId:item.id}}, "", "#player-"+item.id);
  }}
}}

function closePlayer() {{
  overlay.style.display='none';
  iframe.src='';
}}

window.addEventListener("popstate", function(e) {{
  const state = e.state;
  if(!state || state.page==="grid" || state.page==="home") {{
    closePlayer();
    detailPage.style.display = 'none';
    grid.style.display = 'grid';
    return;
  }}
  const itemId = state.itemId;
  const item = allData.find(x => String(x.id) === String(itemId));
  if(!item) {{
    closePlayer();
    detailPage.style.display = 'none';
    grid.style.display = 'grid';
    return;
  }}
  if(state.page==="player") {{
    openPlayer(item, false);
  }} else if(state.page==="detail") {{
    closePlayer();
    openDetail(item, false);
  }} else {{
    closePlayer();
    detailPage.style.display = 'none';
    grid.style.display = 'grid';
  }}
}});

let currentType='movie', currentList=[], shown=0;

function render(reset=false) {{
  if(reset){{ grid.innerHTML=''; shown=0; }}
  let count=0;
  let s = document.getElementById('searchBox').value.toLowerCase();
  let gSel = Array.from(document.getElementById('genreSelect').selectedOptions).map(o=>o.value);
  while(shown<currentList.length && count<40) {{
    let m = currentList[shown++];
    let isFav = favorites.includes(m.id);
    let genreMatch = 
      gSel.length===0 
      || gSel.includes('all') 
      || (gSel.includes('favorites') && isFav) 
      || gSel.every(g => m.genres.includes(g));
    if(genreMatch && m.title.toLowerCase().includes(s)) {{
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <img class='poster' src='${{m.poster}}' alt='${{m.title}}'>
        <div class='badge'>${{m.vote}}</div>
        <p style="margin:2px 0;font-size:12px;color:#ccc;">
          ${{m.duration ? m.duration + ' min • ' : ''}}${{m.year ? m.year : ''}}
        </p>
        <span class="favorite-btn ${{isFav ? 'active' : ''}}" style="pointer-events:none;">★</span>
      `;
      card.onclick = () => openDetail(m);
      grid.appendChild(card);
      count++;
    }}
  }}
}}

function populateGenres(){{
  const set=new Set();
  currentList.forEach(m=>m.genres.forEach(g=>set.add(g)));
  const sel=document.getElementById('genreSelect');
  sel.innerHTML='<option value="all">Tutti i generi</option><option value="favorites">★ Preferiti</option>';
  [...set].sort().forEach(g=>{{
    const o=document.createElement('option');
    o.value=o.textContent=g;
    sel.appendChild(o);
  }});
}}

function updateType(t){{
  currentType=t;
  currentList=allData.filter(x=>x.type===t);
  populateGenres();
  render(true);
}}

/* Eventi UI */
document.getElementById('typeSelect').onchange=e=>updateType(e.target.value);
document.getElementById('genreSelect').onchange=()=>render(true);
document.getElementById('searchBox').oninput=()=>render(true);
document.getElementById('loadMore').onclick=()=>render(false);

/* stato iniziale nella history */
history.replaceState({{page:"grid"}}, "", "#grid");

updateType('movie');

/* scroll latest */
function showLatest(){{
  let scrollPos = 0;
  function scroll() {{
    scrollPos += 1;
    if(scrollPos > latestDiv.scrollWidth - latestDiv.clientWidth) scrollPos = 0;
    latestDiv.scrollTo({{ left: scrollPos, behavior: 'smooth' }});
  }}
  setInterval(scroll, 30);
}}
showLatest();
</script>
